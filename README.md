## Архитектура микросервиса

1. **Входной слой**:
   - **FastAPI**: Обработка входящих POST-запросов с анкетами-заявками.
   - **Очередь Redis**: Используется для асинхронной обработки заявок и повышения отказоустойчивости.

2. **Логика обработки**:
   - **Сервис рейтинга**: Присваивает рейтинги на основе полученных данных.
   - **Сервис сверки данных**: Проверяет несоответствия между заявкой и данными из API.

3. **Интеграции с внешними API**:
   - **REST API**: Получение информации о клиенте и объекте залога.
   - **OAuth и API-ключи**: Аутентификация и авторизация для доступа к API.

4. **Хранилище данных**:
   - **MySQL**: Сохранение заявок и результатов обработки.

5. **Логирование и мониторинг**:
   - **ELK Stack**: Сбор и анализ логов для мониторинга системы.

6. **Интерфейс взаимодействия**:
   - **JSON API**: Возврат результатов в формате JSON для последующего преобразования в человеко-читаемый вид.

## Файловая структура

/project-root
│
├── /app
│   ├── main.py               # Точка входа в приложение FastAPI
│   ├── /api
│   │   ├── endpoints.py      # Определение API-эндпоинтов
│   │   └── dependencies.py   # Зависимости и middleware
│   ├── /services
│   │   ├── rating.py         # Логика присвоения рейтингов
│   │   ├── verification.py   # Логика сверки данных
│   │   └── external_api.py   # Логика взаимодействия с внешними API
│   ├── /models
│   │   ├── request.py        # Модели данных для заявки
│   │   └── response.py       # Модели данных для ответа
│   ├── /database
│   │   ├── connection.py     # Настройка подключения к MySQL
│   │   └── models.py         # SQLAlchemy модели
│   └── /utils
│       ├── logging.py        # Настройка логирования
│       └── config.py         # Конфигурация приложения
│
├── /tests
│   ├── test_endpoints.py     # Тесты для API-эндпоинтов
│   ├── test_services.py      # Тесты для сервисов
│   └── test_models.py        # Тесты для моделей данных
│
├── /scripts
│   ├── start.sh              # Скрипт для запуска приложения
│   └── migrate.sh            # Скрипт для миграции базы данных
│
├── .env                      # Конфигурация окружения
├── requirements.txt          # Зависимости Python
└── README.md                 # Документация проекта

## План разработки

### 1. Разработка API
#### 1.1 Определение контрактов API
- Определить контракты API, включая структуру запросов и ответов в формате JSON.
- Документировать эндпоинты, методы HTTP (GET, POST) и параметры запросов.

#### 1.2 Реализация эндпоинтов
- Создать файл `endpoints.py` в папке `/app/api`.
- Реализовать эндпоинты для получения и обработки заявок.
- Использовать FastAPI для определения маршрутов и асинхронной обработки запросов.

#### 1.3 Middleware и зависимости
- В `dependencies.py` реализовать middleware для обработки аутентификации (OAuth, API-ключи).
- Настроить CORS, если требуется, для взаимодействия с внешними клиентами.

### 2. Взаимодействие с базой данных
#### 2.1 Настройка подключения
- В `connection.py` настроить подключение к базе данных MySQL с использованием aiomysql.
- Использовать `python-dotenv` для загрузки конфигурации из файла `.env`.

#### 2.2 Определение моделей данных
- В `models.py` создать SQLAlchemy модели для хранения данных заявок и результатов.
- Определить связи между таблицами, если это необходимо.

### 3. Реализация бизнес-логики
#### 3.1 Логика присвоения рейтингов
- В `rating.py` реализовать алгоритм присвоения рейтингов заявкам на основе полученных данных.
- Использовать pandas для обработки и анализа данных.

#### 3.2 Логика сверки данных
- В `verification.py` реализовать логику проверки данных из анкеты с данными, полученными через внешние API.
- Определить критерии для выявления расхождений.

#### 3.3 Взаимодействие с внешними API
- В `external_api.py` реализовать функции для обращения к внешним API с использованием httpx.
- Настроить обработку ошибок и повторные попытки в случае неудачных запросов.

### 4. Настройка инфраструктуры
#### 4.1 Логирование
- В `logging.py` настроить логирование с использованием elastic-apm для сбора и анализа логов.
- Определить уровень логирования (DEBUG, INFO, ERROR) для различных компонентов приложения.

#### 4.2 Конфигурация приложения
- В `config.py` настроить основные параметры приложения, такие как порты, URL-адреса API и другие настройки.

#### 4.3 Очереди сообщений
- Настроить использование Redis в качестве брокера для очередей задач, если требуется асинхронная обработка.

### 5. Запуск приложения
#### 5.1 Написание скриптов запуска и миграции
- В `start.sh` написать скрипт для запуска приложения с использованием uvicorn.
- В `migrate.sh` реализовать скрипт для выполнения миграций базы данных.

#### 5.2 Настройка окружения
- Настроить виртуальное окружение и установить зависимости из `requirements.txt`.
- Убедиться, что все переменные окружения корректно загружаются из `.env`.

#### 5.3 Запуск и проверка
- Запустить приложение и проверить работу всех эндпоинтов.
- Провести базовую проверку интеграции с базой данных и внешними API.